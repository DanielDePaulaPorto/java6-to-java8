language: ruby
sudo: required

env:
  global:
    - secure: ygR+ubsOCcsILpZ9ftQ7hYeYohHS4K4U8l1LSimNoNgvf+6xxu9Pjp/uTbiWWj/J4Jc9uQiITM3h5hRxZKNO+m7kQKprRcEXIaT/vDkQWmWB+4G72hon5fwqdhKW++i5IOOXUUPQrEqpXovccgBiwVdwfvMjtp9WIx2lGDNPHAu9rzWJhQF9qlHq+an61K+Ft65OI00qgr6C7Os/va3YZFsdK+0Y4WasX2pXJgvf5TQvyso74JtgNeA1mfcHGp3/bRivi30TOVMtHLnjTIFEVt1ekxnxeJAWkvONsC9+ZPnqF5+9/QdzRXQ9uVaQSwWB6uZQIu18i10UFP92/CM0KyOXvbr8FikjTCsQcc7RThu33eGNlU5CyPvyjweMLHFobaJqTarAd+R7B0VLY8pmAbpt0rLqYOVJvZ8fLzqIDkos+TuGYapBiKMHnnp2oNEgruIB88sxeaBgfbzx+Q36vVA4u79+BJZEA8C+DJYJ+s+NFvFqRvkxsJmQ3gmRtTKgUgQ7WP40/TFLwv3rBodkMBMygjcCAoOKVvYDuTi165vT8ABztgE8G5Z5lnOhPpezZ2dwLh64Do0BGOqMIsIC6Sx4XX8Pg7xnVXenfE+9AN2mCeZNq2tq0kTRqhclr+2T5IdUm9zB90I2VfK+6tuOPsb4DKhhJRtZsUZLMCIW4NA=

jobs:
  include:
    - stage: "Semantic Release"
      name: "Generate a new release and changelogs"
      language: node_js
      node_js: lts/*
      os:
        - linux
      install:
        - npm install
      script: skip
      deploy:
        provider: script
        api_key: "$GITHUB_TOKEN"
        node_js: lts/*
        skip_cleanup: true
        script: npx semantic-release
        on:
          branch: master

    - stage: "GitHub Release"
      name: "Send the generated files to the new GitHub release"
      services:
        - docker
      env:
        - COMPOSE_FILE=docker-compose.yml
      script:
        - TRAVIS_TAG=$(git describe --tags `git rev-list --tags --max-count=1`)
        - git shortlog -s | cut -f 2- > book/contributors.txt
        - docker-compose run --rm ebook $TRAVIS_TAG
      deploy:
        provider: releases
        api_key: "$GITHUB_TOKEN"
        file_glob: true
        file: book-release/*
        skip_cleanup: true
        on:
          branch: master
